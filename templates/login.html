<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <title>Вход</title>
</head>


<body>
    <div class="container">
        <form class="registration-form">
            <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="126" height="126" viewBox="0 0 512 512">
                    <path
                        d="M64,480H48a32,32,0,0,1-32-32V112A32,32,0,0,1,48,80H64a32,32,0,0,1,32,32V448A32,32,0,0,1,64,480Z" />
                    <path d="M240,176a32,32,0,0,0-32-32H144a32,32,0,0,0-32,32v28a4,4,0,0,0,4,4H236a4,4,0,0,0,4-4Z" />
                    <path d="M112,448a32,32,0,0,0,32,32h64a32,32,0,0,0,32-32V418a2,2,0,0,0-2-2H114a2,2,0,0,0-2,2Z" />
                    <rect x="112" y="240" width="128" height="144" rx="2" ry="2" />
                    <path
                        d="M320,480H288a32,32,0,0,1-32-32V64a32,32,0,0,1,32-32h32a32,32,0,0,1,32,32V448A32,32,0,0,1,320,480Z" />
                    <path
                        d="M495.89,445.45l-32.23-340c-1.48-15.65-16.94-27-34.53-25.31l-31.85,3c-17.59,1.67-30.65,15.71-29.17,31.36l32.23,340c1.48,15.65,16.94,27,34.53,25.31l31.85-3C484.31,475.14,497.37,461.1,495.89,445.45Z" />
                </svg>
            </div>
            <h1>Вход</h1>
            <div class="input-group">
                <label for="email">Электронная почта</label>
                <input type="email" id="email" name="email" required placeholder="Введите ваш Email">
            </div>
            <div class="input-group">
                <label for="password">Пароль</label>
                <input type="password" id="password" name="password" required placeholder="Введите ваш пароль">
            </div>
            <div id="output"></div>
            <button id="loginButton" type="button">Войти</button>
            <p>Еще нет аккаунта? <a href="/register">Зарегистрироваться</a></p>

        </form>
    </div>

    <script>
        function showError(input_element, message) {
            // Создаем ошибку и ее свойства
            let error = document.createElement("label");
            // Задаем параметры для элемента ошибки 
            error.className = "error";
            error.style.color = "red";
            error.style.paddingLeft = "6px";
            error.style.paddingTop = "6px";
            error.style.fontSize = "12px";
            error.innerHTML = message;

            // Удаляем ошибки на страничке, все прошлые
            const all_errors = input_element.parentElement.querySelectorAll(".error");
            all_errors.forEach(element => element.remove());

            // Вставляем ошибку над неправильнно веденном поле, новую
            input_element.parentElement.insertBefore(error, input_element);
        }

        function validateEmail(email) {
            const regex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
            return regex.test(email);
        }

        async function sendData(data) {
            try {
                // Осуществляем отправку через fetch
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' // Для JSON данных
                    },
                    body: JSON.stringify(data) // Преобразуем данные в JSON
                });


                if (response.status === 500) {
                    console.log("Ошибка сервера! Статус 500");
                }
                else if (response.status === 400) {
                    const result = await response.json();
                    console.log("Не успешно, ошибка в передачи данных, 400:", result);
                }
                else if (response.status === 401) {
                    document.getElementById("output").textContent = "Неверный пароль для данного аккаунта";
                    const result = await response.json();
                    console.log("Не успешно, ошибка во входе, 401:", result);
                }
                else if (response.status === 404) {
                    document.getElementById("output").textContent = "Такого пользователя не существует.\nПожалуйста зарегестрируйтесь";
                    const result = await response.json();
                    console.log("Не успешно, ошибка во входе, 404:", result);
                }

                else {
                    const result = await response.json(); // Парсим JSON ответ
                    console.log('Успешно:', result);
                    window.location.href = "/home";  // Перенаправляем на страничку /login
                }
            }
            catch (error) {
                // Выдачи ошибки
                console.error('Ошибка:', error);
            }
        }

        async function btnClick() {
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value.trim();

            const divOutput = document.getElementById("output");
            divOutput.textContent = "";

            console.log(email, password)

            const errors = document.querySelectorAll(".error");
            errors.forEach(error => error.remove());

            is_valid = true;

            if (!validateEmail(email)) {
                showError(document.getElementById("email"), "Неккоректный email");
                console.log("Неккоректный email");
                is_valid = false;
            }
            if (is_valid === true) {
                const myData = {
                    "email": email,
                    "password": password,
                };
                // console.log(myData)
                sendData(myData);
            }
        }
        document.getElementById("loginButton").addEventListener("click", btnClick)

    </script>

</body>

</html>